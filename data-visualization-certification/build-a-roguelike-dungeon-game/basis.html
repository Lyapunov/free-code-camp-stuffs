<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
            cursor : none;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;
         var tileSize = 35;
         var errorTolerance = 0.01;
         var mapRadiusX = screenWidth/2/tileSize/Math.sqrt(3);
         var mapRadiusY = screenHeight/2/tileSize;
         var mapRadius = Math.ceil(2 * Math.max(mapRadiusX,mapRadiusY));

         var fps = 25;
         var aiFrequencyDecreaseRatio = 5; // AI runs in every (1 / fps * aiFrequenceDecreasingRatio) second
         var aiCounter = 0;
         var ANIMATION;

         var curX = 0;
         var curY = 0;
         var currentTarget = 0;

         //================================= AVATAR ANIMATION BEGINS =================================

         var characterBodyDrawData = 
[
[[20,29,5],[19,34,5],[18,40,5],[17,46,5],[18,52,5],[18,57,5],[18,62,5],[19,68,5],[19,74,5],[19,81,5],[17,12,15],[19,29,12],[18,47,12],[27,32,5],[28,39,5],[28,47,5],[28,55,5],[26,62,5],[22,60,5],[23,67,5],[23,75,5],[24,82,5],[24,88,5]],
[[21,30,5],[21,36,5],[21,44,5],[18,51,5],[13,55,5],[19,58,5],[19,64,5],[16,69,5],[25,74,5],[33,76,5],[17,11,15],[20,29,12],[19,46,12],[28,32,5],[29,40,5],[30,47,5],[30,55,5],[28,62,5],[23,59,5],[23,66,5],[23,73,5],[24,81,5],[25,88,5]],
[[24,31,5],[27,36,5],[28,43,5],[29,48,5],[28,55,5],[19,56,5],[15,62,5],[10,69,5],[13,73,5],[14,78,5],[17,10,15],[20,29,12],[21,43,12],[23,31,5],[22,38,5],[21,45,5],[19,52,5],[15,57,5],[24,56,5],[25,65,5],[26,73,5],[29,81,5],[33,88,5]],
[[29,28,5],[31,35,5],[32,42,5],[32,48,5],[31,54,5],[19,57,5],[15,62,5],[11,68,5],[7,75,5],[3,80,5],[17,11,15],[20,29,12],[19,45,12],[22,31,5],[16,51,5],[19,44,5],[21,37,5],[12,55,5],[25,57,5],[27,65,5],[30,74,5],[38,79,5],[45,84,5]],
[[29,32,5],[31,37,5],[32,44,5],[34,49,5],[33,55,5],[19,58,5],[14,63,5],[10,68,5],[11,75,5],[12,81,5],[16,15,15],[20,33,12],[20,46,12],[21,33,5],[21,41,5],[21,48,5],[17,53,5],[12,54,5],[25,58,5],[26,65,5],[27,72,5],[32,77,5],[39,81,5]],
[[25,33,5],[28,40,5],[28,46,5],[28,53,5],[28,60,5],[20,63,5],[19,58,5],[18,70,5],[21,76,5],[22,82,5],[16,12,15],[19,31,12],[20,45,12],[24,33,5],[23,40,5],[21,46,5],[20,52,5],[15,58,5],[24,57,5],[21,63,5],[20,69,5],[27,73,5],[33,75,5]],
[[20,29,5],[20,37,5],[20,45,5],[16,50,5],[13,54,5],[23,56,5],[25,63,5],[26,69,5],[28,75,5],[29,80,5],[17,9,15],[20,29,12],[21,44,12],[26,30,5],[27,38,5],[29,46,5],[29,54,5],[28,60,5],[22,55,5],[18,60,5],[16,66,5],[18,72,5],[20,77,5]],
[[21,30,5],[16,46,5],[20,41,5],[21,33,5],[13,51,5],[26,59,5],[28,66,5],[31,71,5],[37,75,5],[43,78,5],[16,11,15],[19,30,12],[20,46,12],[29,30,5],[31,36,5],[34,42,5],[34,49,5],[34,56,5],[21,59,5],[17,67,5],[12,74,5],[7,82,5],[2,89,5]],
[[20,33,5],[19,35,5],[19,42,5],[16,48,5],[12,51,5],[24,59,5],[24,66,5],[26,73,5],[32,76,5],[39,77,5],[17,15,15],[19,32,12],[20,46,12],[26,34,5],[31,37,5],[34,46,5],[35,53,5],[35,59,5],[19,59,5],[15,66,5],[10,74,5],[11,81,5],[12,87,5]],
[[17,29,5],[15,35,5],[13,42,5],[12,49,5],[12,56,5],[17,55,5],[17,62,5],[17,69,5],[18,77,5],[19,84,5],[17,13,15],[19,29,12],[18,43,12],[31,32,5],[32,40,5],[32,48,5],[32,56,5],[30,63,5],[25,56,5],[25,63,5],[26,72,5],[27,80,5],[29,88,5]],
[[18,29,5],[17,35,5],[16,41,5],[15,48,5],[14,55,5],[19,55,5],[19,62,5],[18,70,5],[25,69,5],[31,67,5],[18,12,15],[20,28,12],[19,44,12],[31,28,5],[33,35,5],[35,43,5],[34,51,5],[32,58,5],[26,55,5],[26,62,5],[26,69,5],[28,77,5],[30,84,5]],
[[20,27,5],[19,33,5],[20,39,5],[19,44,5],[19,50,5],[28,53,5],[28,59,5],[28,68,5],[31,74,5],[34,81,5],[18,10,15],[20,27,12],[21,40,12],[29,30,5],[29,36,5],[28,43,5],[26,51,5],[23,58,5],[20,52,5],[16,59,5],[12,66,5],[15,71,5],[20,76,5]],
[[22,28,5],[25,33,5],[26,39,5],[29,42,5],[31,47,5],[21,54,5],[16,62,5],[14,69,5],[11,77,5],[8,84,5],[18,11,15],[19,28,12],[20,43,12],[30,30,5],[29,37,5],[26,44,5],[23,51,5],[19,56,5],[27,54,5],[28,59,5],[30,65,5],[34,70,5],[40,74,5]],
[[20,31,5],[20,35,5],[22,39,5],[27,42,5],[31,45,5],[20,56,5],[15,62,5],[11,69,5],[11,76,5],[10,84,5],[18,15,15],[20,31,12],[20,44,12],[30,33,5],[28,40,5],[25,47,5],[22,52,5],[18,57,5],[26,55,5],[28,62,5],[30,68,5],[35,71,5],[40,73,5]],
[[20,29,5],[20,35,5],[20,40,5],[21,45,5],[21,50,5],[26,50,5],[25,57,5],[25,64,5],[29,67,5],[34,69,5],[17,12,15],[21,29,12],[21,41,12],[30,29,5],[31,37,5],[31,45,5],[30,52,5],[29,59,5],[20,51,5],[20,58,5],[20,65,5],[21,72,5],[25,79,5]],
[[18,28,5],[17,34,5],[16,41,5],[14,46,5],[11,52,5],[20,51,5],[19,56,5],[21,64,5],[25,69,5],[27,76,5],[18,9,15],[20,27,12],[20,39,12],[31,28,5],[33,34,5],[35,40,5],[36,47,5],[36,53,5],[26,50,5],[23,56,5],[20,61,5],[20,69,5],[20,76,5]],
[[17,29,5],[17,34,5],[14,40,5],[12,46,5],[11,52,5],[20,54,5],[21,59,5],[23,64,5],[28,70,5],[33,72,5],[18,11,15],[20,29,12],[20,42,12],[32,30,5],[34,35,5],[37,42,5],[39,47,5],[40,54,5],[25,62,5],[22,71,5],[27,55,5],[19,80,5],[17,90,5]],
[[17,32,5],[16,38,5],[13,43,5],[11,49,5],[9,54,5],[20,56,5],[19,64,5],[20,71,5],[26,71,5],[31,71,5],[17,15,15],[20,31,12],[20,44,12],[31,31,5],[33,37,5],[36,42,5],[38,49,5],[38,56,5],[25,64,5],[27,56,5],[21,70,5],[23,87,5],[22,79,5]],
[[16,31,5],[14,38,5],[13,45,5],[14,52,5],[15,58,5],[20,58,5],[20,65,5],[20,72,5],[20,80,5],[21,88,5],[19,13,15],[21,30,12],[21,46,12],[33,31,5],[35,37,5],[36,45,5],[35,52,5],[34,58,5],[29,58,5],[29,65,5],[29,72,5],[28,80,5],[28,87,5]],
[[16,29,5],[15,36,5],[15,43,5],[14,50,5],[15,57,5],[21,55,5],[20,63,5],[20,71,5],[23,68,5],[23,64,5],[19,12,15],[21,28,12],[21,43,12],[33,28,5],[34,35,5],[34,42,5],[34,50,5],[33,57,5],[28,55,5],[29,62,5],[29,68,5],[28,75,5],[27,82,5]],
[[17,28,5],[16,34,5],[16,39,5],[17,45,5],[19,50,5],[28,53,5],[28,72,5],[28,65,5],[29,59,5],[28,78,5],[19,10,15],[21,27,12],[22,41,12],[32,28,5],[34,34,5],[34,40,5],[33,48,5],[31,54,5],[20,59,5],[21,53,5],[18,64,5],[19,70,5],[21,75,5]],
[[17,28,5],[17,34,5],[18,40,5],[19,46,5],[20,51,5],[29,53,5],[31,55,5],[30,58,5],[28,62,5],[26,65,5],[20,11,15],[22,28,12],[22,42,12],[33,28,5],[33,35,5],[33,42,5],[31,50,5],[26,57,5],[21,62,5],[21,54,5],[21,78,5],[21,70,5],[21,86,5]],
[[17,31,5],[16,36,5],[17,42,5],[17,47,5],[18,53,5],[28,56,5],[29,65,5],[30,61,5],[28,68,5],[26,71,5],[19,15,15],[22,31,12],[22,44,12],[32,31,5],[34,38,5],[34,45,5],[34,53,5],[30,59,5],[20,57,5],[20,70,5],[21,76,5],[20,63,5],[21,82,5]],
[[16,29,5],[15,36,5],[14,44,5],[15,50,5],[15,57,5],[21,54,5],[20,60,5],[20,68,5],[21,75,5],[21,82,5],[20,13,15],[21,29,12],[21,42,12],[33,29,5],[34,36,5],[34,43,5],[34,50,5],[33,57,5],[28,54,5],[27,67,5],[29,70,5],[29,61,5],[27,66,5]],
[[32,28,5],[33,33,5],[32,38,5],[32,44,5],[30,49,5],[21,53,5],[20,65,5],[21,59,5],[21,71,5],[21,77,5],[19,10,15],[21,27,12],[21,41,12],[17,27,5],[16,33,5],[15,40,5],[16,47,5],[18,54,5],[28,53,5],[30,58,5],[31,64,5],[30,70,5],[27,75,5]],
[[31,27,5],[30,43,5],[32,37,5],[32,32,5],[31,48,5],[21,53,5],[19,56,5],[19,59,5],[21,61,5],[23,64,5],[20,11,15],[21,27,12],[21,41,12],[18,28,5],[16,34,5],[17,42,5],[18,49,5],[23,57,5],[28,53,5],[29,61,5],[29,69,5],[29,77,5],[28,86,5]],
[[33,31,5],[32,37,5],[33,43,5],[32,49,5],[30,53,5],[21,57,5],[21,60,5],[20,64,5],[21,68,5],[22,71,5],[19,15,15],[21,31,12],[21,45,12],[17,31,5],[15,38,5],[15,46,5],[16,52,5],[19,58,5],[28,57,5],[29,63,5],[29,71,5],[29,77,5],[28,83,5]],
[[34,27,5],[36,34,5],[37,42,5],[38,49,5],[38,56,5],[25,55,5],[24,64,5],[24,72,5],[23,80,5],[22,88,5],[22,12,15],[24,29,12],[25,43,12],[19,32,5],[18,40,5],[17,47,5],[19,54,5],[20,61,5],[33,54,5],[33,61,5],[33,68,5],[33,76,5],[31,83,5]],
[[29,29,5],[29,36,5],[29,42,5],[30,47,5],[30,52,5],[30,52,5],[30,59,5],[30,66,5],[29,73,5],[26,80,5],[22,12,15],[24,28,12],[23,41,12],[20,28,5],[19,35,5],[18,43,5],[20,51,5],[21,58,5],[25,52,5],[25,59,5],[24,66,5],[20,69,5],[14,70,5]],
[[32,28,5],[33,34,5],[34,40,5],[36,46,5],[38,51,5],[30,51,5],[31,57,5],[30,62,5],[25,69,5],[22,75,5],[22,10,15],[23,27,12],[23,40,12],[20,28,5],[17,33,5],[16,39,5],[14,47,5],[13,54,5],[27,56,5],[25,50,5],[30,62,5],[31,70,5],[29,76,5]],
[[33,29,5],[34,34,5],[36,40,5],[37,45,5],[40,50,5],[30,54,5],[29,60,5],[29,67,5],[23,70,5],[17,73,5],[22,11,15],[23,28,12],[23,43,12],[18,30,5],[16,36,5],[14,42,5],[12,47,5],[11,53,5],[23,55,5],[25,63,5],[29,75,5],[30,82,5],[33,90,5]],
[[33,31,5],[34,37,5],[36,43,5],[38,48,5],[41,53,5],[31,57,5],[31,64,5],[30,71,5],[25,71,5],[19,72,5],[22,15,15],[23,31,12],[24,46,12],[19,32,5],[16,37,5],[14,43,5],[12,49,5],[11,55,5],[23,59,5],[25,64,5],[29,70,5],[28,79,5],[27,87,5]],
[[31,30,5],[32,36,5],[34,42,5],[34,48,5],[36,54,5],[31,55,5],[31,62,5],[31,70,5],[26,70,5],[20,66,5],[22,12,15],[23,29,12],[24,44,12],[20,30,5],[17,37,5],[16,44,5],[16,51,5],[17,57,5],[24,55,5],[24,63,5],[23,70,5],[22,77,5],[20,84,5]],
[[29,27,5],[30,32,5],[30,37,5],[30,44,5],[31,51,5],[23,52,5],[22,59,5],[22,67,5],[19,75,5],[14,82,5],[22,10,15],[22,27,12],[23,40,12],[21,28,5],[22,35,5],[21,43,5],[24,51,5],[27,57,5],[31,51,5],[35,59,5],[39,66,5],[35,71,5],[30,77,5]],
[[31,27,5],[28,31,5],[27,37,5],[23,42,5],[20,47,5],[33,53,5],[34,60,5],[36,68,5],[39,75,5],[42,84,5],[23,11,15],[24,29,12],[24,42,12],[21,30,5],[22,36,5],[24,43,5],[28,49,5],[31,55,5],[23,51,5],[22,57,5],[22,63,5],[16,69,5],[10,75,5]],
[[30,31,5],[28,35,5],[27,38,5],[23,42,5],[19,45,5],[32,53,5],[35,60,5],[38,67,5],[40,76,5],[40,83,5],[22,15,15],[24,32,12],[24,45,12],[21,33,5],[23,38,5],[24,46,5],[28,51,5],[31,55,5],[24,54,5],[22,60,5],[21,67,5],[16,71,5],[9,73,5]],
[[27,30,5],[29,35,5],[31,40,5],[31,46,5],[30,52,5],[29,57,5],[29,63,5],[29,70,5],[28,75,5],[27,81,5],[20,12,15],[21,31,12],[22,46,12],[20,33,5],[18,40,5],[18,49,5],[20,55,5],[21,63,5],[26,58,5],[26,65,5],[24,72,5],[23,80,5],[22,88,5]],
[[22,32,5],[20,37,5],[18,44,5],[18,52,5],[19,59,5],[26,57,5],[27,63,5],[28,69,5],[26,76,5],[24,82,5],[20,12,15],[20,30,12],[20,45,12],[23,32,5],[24,38,5],[26,45,5],[28,52,5],[32,57,5],[23,58,5],[25,63,5],[28,69,5],[22,73,5],[15,76,5]],
[[26,28,5],[26,35,5],[26,43,5],[30,48,5],[34,53,5],[25,53,5],[23,61,5],[21,68,5],[19,74,5],[17,80,5],[20,10,15],[21,29,12],[21,41,12],[21,30,5],[20,37,5],[19,45,5],[19,52,5],[19,59,5],[23,53,5],[28,58,5],[31,65,5],[30,72,5],[27,77,5]],
[[26,30,5],[26,35,5],[26,39,5],[29,45,5],[33,50,5],[27,55,5],[20,64,5],[16,71,5],[11,75,5],[3,78,5],[21,11,15],[21,29,12],[20,44,12],[18,30,5],[16,35,5],[14,41,5],[12,49,5],[13,55,5],[22,57,5],[29,64,5],[35,72,5],[40,81,5],[45,89,5]],
[[27,32,5],[26,37,5],[27,42,5],[30,48,5],[35,51,5],[28,55,5],[24,63,5],[23,71,5],[16,75,5],[8,77,5],[21,15,15],[21,33,12],[21,46,12],[20,34,5],[16,39,5],[14,45,5],[12,52,5],[12,60,5],[23,57,5],[30,64,5],[36,72,5],[36,80,5],[35,88,5]],
[[26,30,5],[27,36,5],[26,43,5],[29,50,5],[33,55,5],[27,57,5],[29,63,5],[30,69,5],[22,73,5],[14,76,5],[20,12,15],[21,31,12],[21,46,12],[21,30,5],[18,38,5],[17,45,5],[17,53,5],[19,61,5],[24,58,5],[24,65,5],[24,73,5],[23,80,5],[22,88,5]],
[[22,29,5],[21,35,5],[19,41,5],[19,49,5],[19,55,5],[27,54,5],[33,61,5],[37,67,5],[36,73,5],[33,78,5],[20,10,15],[20,29,12],[21,43,12],[25,31,5],[25,38,5],[27,45,5],[29,52,5],[32,57,5],[23,56,5],[23,65,5],[21,75,5],[18,82,5],[14,88,5]],
[[20,28,5],[16,33,5],[14,40,5],[15,46,5],[15,52,5],[29,55,5],[32,61,5],[35,67,5],[39,73,5],[44,80,5],[20,11,15],[21,27,12],[21,43,12],[26,32,5],[26,37,5],[28,44,5],[30,50,5],[35,54,5],[23,55,5],[21,65,5],[16,74,5],[9,80,5],[2,85,5]],
[[20,32,5],[17,36,5],[14,41,5],[14,47,5],[13,53,5],[29,57,5],[33,62,5],[37,67,5],[36,74,5],[34,81,5],[20,15,15],[20,33,12],[21,46,12],[26,36,5],[27,41,5],[27,45,5],[29,50,5],[34,54,5],[23,57,5],[22,64,5],[19,71,5],[14,76,5],[7,81,5]],
[[14,30,5],[13,37,5],[13,44,5],[14,50,5],[15,56,5],[20,55,5],[20,62,5],[19,69,5],[18,76,5],[17,83,5],[19,13,15],[19,30,12],[20,45,12],[31,32,5],[33,38,5],[34,47,5],[34,54,5],[34,62,5],[28,57,5],[28,63,5],[28,72,5],[28,80,5],[27,88,5]],
[[15,29,5],[15,35,5],[14,41,5],[14,47,5],[15,54,5],[19,53,5],[18,60,5],[18,67,5],[17,75,5],[16,82,5],[19,11,15],[19,29,12],[19,42,12],[30,30,5],[30,37,5],[30,44,5],[31,51,5],[33,59,5],[26,54,5],[28,61,5],[28,67,5],[24,73,5],[20,79,5]],
[[16,27,5],[17,32,5],[21,39,5],[22,44,5],[22,48,5],[25,53,5],[30,59,5],[34,63,5],[31,71,5],[29,77,5],[19,10,15],[19,28,12],[19,41,12],[29,31,5],[27,38,5],[27,45,5],[27,52,5],[27,59,5],[19,53,5],[19,60,5],[17,67,5],[15,75,5],[13,82,5]],
[[17,28,5],[18,33,5],[20,38,5],[22,43,5],[25,46,5],[18,55,5],[16,63,5],[14,71,5],[9,78,5],[4,86,5],[19,11,15],[19,29,12],[18,42,12],[28,32,5],[25,39,5],[24,46,5],[23,54,5],[23,61,5],[27,55,5],[32,62,5],[36,68,5],[39,73,5],[44,79,5]],
[[17,30,5],[18,35,5],[20,38,5],[22,42,5],[26,47,5],[19,57,5],[18,64,5],[16,72,5],[11,77,5],[6,82,5],[20,15,15],[19,31,12],[19,45,12],[28,35,5],[25,42,5],[23,48,5],[22,56,5],[22,63,5],[27,58,5],[30,63,5],[35,67,5],[36,75,5],[37,82,5]],
[[15,28,5],[14,34,5],[15,39,5],[15,45,5],[17,52,5],[24,53,5],[26,63,5],[25,71,5],[25,79,5],[24,87,5],[19,12,15],[19,29,12],[17,42,12],[28,33,5],[27,40,5],[26,47,5],[25,55,5],[24,62,5],[17,53,5],[19,61,5],[21,68,5],[16,72,5],[11,74,5]],
[[17,28,5],[15,34,5],[14,40,5],[14,47,5],[14,53,5],[18,54,5],[22,58,5],[27,62,5],[28,67,5],[29,71,5],[19,10,15],[20,28,12],[19,42,12],[30,30,5],[31,36,5],[31,43,5],[32,50,5],[33,56,5],[25,55,5],[25,65,5],[24,73,5],[22,81,5],[21,88,5]],
[[17,29,5],[14,35,5],[12,41,5],[12,48,5],[12,55,5],[18,52,5],[22,57,5],[26,62,5],[30,67,5],[34,71,5],[19,10,15],[19,29,12],[19,42,12],[30,31,5],[31,37,5],[32,42,5],[34,49,5],[35,54,5],[26,54,5],[22,66,5],[21,76,5],[17,82,5],[13,90,5]],
[[17,32,5],[14,37,5],[12,42,5],[11,49,5],[10,55,5],[19,53,5],[21,60,5],[24,67,5],[24,73,5],[24,78,5],[19,15,15],[20,32,12],[19,45,12],[28,34,5],[30,38,5],[32,43,5],[33,48,5],[36,52,5],[25,54,5],[26,61,5],[27,68,5],[23,73,5],[18,79,5]],
[[16,31,5],[15,38,5],[13,45,5],[14,52,5],[14,59,5],[20,57,5],[20,65,5],[20,73,5],[20,80,5],[21,87,5],[19,13,15],[21,29,12],[21,46,12],[33,30,5],[35,37,5],[35,45,5],[35,52,5],[35,59,5],[29,57,5],[29,65,5],[29,73,5],[29,80,5],[28,87,5]],
[[16,28,5],[15,35,5],[15,43,5],[15,50,5],[15,57,5],[21,55,5],[20,62,5],[19,70,5],[21,78,5],[20,86,5],[19,11,15],[21,27,12],[21,42,12],[33,29,5],[34,35,5],[34,43,5],[34,57,5],[34,50,5],[28,55,5],[29,62,5],[30,69,5],[28,72,5],[26,76,5]],
[[16,27,5],[16,32,5],[17,39,5],[18,45,5],[20,51,5],[28,53,5],[29,57,5],[29,62,5],[29,65,5],[29,69,5],[20,10,15],[21,27,12],[21,41,12],[32,27,5],[33,33,5],[34,41,5],[33,48,5],[33,55,5],[21,53,5],[20,62,5],[19,71,5],[20,79,5],[20,87,5]],
[[18,28,5],[18,34,5],[18,39,5],[20,44,5],[21,49,5],[27,52,5],[28,55,5],[28,58,5],[28,62,5],[29,64,5],[20,11,15],[21,27,12],[21,41,12],[31,28,5],[32,35,5],[32,42,5],[32,48,5],[31,54,5],[19,90,5],[21,52,5],[20,61,5],[20,71,5],[20,80,5]],
[[17,32,5],[17,37,5],[16,42,5],[18,47,5],[19,52,5],[28,55,5],[29,59,5],[29,63,5],[29,67,5],[29,70,5],[20,15,15],[22,31,12],[21,44,12],[32,32,5],[34,38,5],[33,45,5],[33,52,5],[32,59,5],[21,55,5],[20,61,5],[19,67,5],[21,73,5],[22,79,5]],
[[16,29,5],[15,36,5],[14,44,5],[15,51,5],[15,57,5],[20,56,5],[20,64,5],[19,71,5],[21,74,5],[22,76,5],[20,11,15],[21,28,12],[21,45,12],[32,29,5],[33,36,5],[34,43,5],[34,50,5],[34,56,5],[29,56,5],[29,63,5],[29,69,5],[28,77,5],[28,86,5]],
[[33,28,5],[33,33,5],[33,38,5],[32,44,5],[30,49,5],[20,52,5],[21,56,5],[20,60,5],[20,65,5],[20,68,5],[19,10,15],[21,27,12],[21,41,12],[18,28,5],[16,35,5],[15,42,5],[16,49,5],[17,56,5],[28,52,5],[29,60,5],[29,69,5],[29,79,5],[30,87,5]],
[[31,29,5],[31,33,5],[30,38,5],[30,41,5],[29,46,5],[22,53,5],[21,56,5],[21,59,5],[20,63,5],[20,65,5],[20,11,15],[21,42,12],[21,28,12],[17,29,5],[17,36,5],[17,42,5],[18,48,5],[18,54,5],[28,54,5],[29,62,5],[29,71,5],[30,81,5],[30,90,5]],
[[32,31,5],[33,38,5],[33,44,5],[32,49,5],[30,54,5],[21,55,5],[20,59,5],[20,63,5],[20,67,5],[19,71,5],[20,15,15],[21,32,12],[22,45,12],[18,31,5],[16,38,5],[16,45,5],[16,53,5],[17,59,5],[28,56,5],[30,61,5],[31,67,5],[29,73,5],[28,79,5]],
[[32,29,5],[33,36,5],[34,43,5],[34,48,5],[33,55,5],[28,55,5],[28,61,5],[29,68,5],[30,75,5],[31,82,5],[19,11,15],[22,30,12],[21,44,12],[18,31,5],[15,38,5],[14,46,5],[14,53,5],[14,61,5],[20,57,5],[20,64,5],[20,72,5],[21,79,5],[22,87,5]],
[[33,27,5],[34,33,5],[34,41,5],[33,47,5],[31,52,5],[31,55,5],[28,63,5],[28,68,5],[32,72,5],[37,75,5],[19,12,15],[24,28,12],[24,43,12],[20,33,5],[21,39,5],[22,47,5],[23,54,5],[23,61,5],[25,55,5],[23,63,5],[23,71,5],[24,79,5],[24,87,5]],
[[32,29,5],[34,35,5],[35,42,5],[34,48,5],[34,54,5],[29,54,5],[25,59,5],[23,62,5],[20,65,5],[20,71,5],[19,10,15],[23,28,12],[23,41,12],[18,30,5],[17,36,5],[17,42,5],[17,49,5],[15,55,5],[23,54,5],[23,62,5],[24,72,5],[26,80,5],[28,88,5]],
[[32,30,5],[34,35,5],[36,42,5],[37,49,5],[35,55,5],[28,53,5],[24,59,5],[21,63,5],[17,67,5],[13,71,5],[19,11,15],[22,29,12],[22,42,12],[18,31,5],[17,36,5],[16,43,5],[15,49,5],[12,54,5],[23,53,5],[25,63,5],[27,73,5],[31,82,5],[34,90,5]],
[[20,34,5],[18,38,5],[17,43,5],[15,47,5],[12,52,5],[29,56,5],[27,60,5],[24,66,5],[24,73,5],[24,79,5],[19,14,15],[23,32,12],[22,44,12],[32,32,5],[35,37,5],[36,43,5],[37,49,5],[38,56,5],[23,55,5],[22,61,5],[22,68,5],[26,73,5],[31,79,5]],
[[33,29,5],[33,34,5],[34,41,5],[34,47,5],[34,53,5],[29,56,5],[29,62,5],[30,68,5],[31,75,5],[32,82,5],[19,11,15],[23,30,12],[23,44,12],[19,31,5],[18,37,5],[18,43,5],[17,50,5],[16,57,5],[22,56,5],[20,62,5],[21,68,5],[25,73,5],[28,79,5]],
[[32,27,5],[32,32,5],[30,38,5],[29,44,5],[28,47,5],[24,54,5],[18,59,5],[14,64,5],[16,70,5],[19,76,5],[19,9,15],[23,27,12],[23,41,12],[19,31,5],[21,37,5],[21,44,5],[22,51,5],[22,58,5],[30,54,5],[30,60,5],[30,66,5],[33,74,5],[35,82,5]],
[[32,27,5],[32,33,5],[31,39,5],[31,44,5],[30,48,5],[21,54,5],[18,60,5],[14,67,5],[9,73,5],[4,79,5],[19,11,15],[23,29,12],[23,43,12],[19,32,5],[22,38,5],[23,46,5],[25,54,5],[26,61,5],[30,54,5],[32,63,5],[34,71,5],[38,79,5],[43,85,5]],
[[31,29,5],[32,36,5],[31,44,5],[29,49,5],[30,52,5],[29,58,5],[31,64,5],[33,70,5],[38,76,5],[42,81,5],[19,15,15],[23,33,12],[23,48,12],[20,35,5],[23,41,5],[24,47,5],[26,55,5],[26,62,5],[22,58,5],[18,64,5],[14,68,5],[12,75,5],[11,82,5]],
];

         var drawDescriptorForWarrior = [[0],[0,1],[1],[1,2],[2],[2,3],[3],[3,4],[4],
                                         [5],[5,6],[6],[6,7],[7],[7,8],[8],[8,9],[9],
                                         [10],[11],[11,12],[12],
                                         [13],[13,14],[14],[14,15],[15],[15,16],[16],[16,17],[17],
                                         [18],[18,19],[19],[19,20],[20],[20,21],[21],[21,22],[22]];

         var drawDescriptorForWarriorWithWeapon = [[23],[23,24,0.75,0.25],[23,24],[23,24,0.25,0.75],[24],[23,24,-0.25,1.25],[23,24,-0.5,1.5],[23,24,-0.75,1.75],[23,24,-1,2],
                                                   [0],[0,1],[1],[1,2],[2],[2,3],[3],[3,4],[4],
                                                   [5],[5,6],[6],[6,7],[7],[7,8],[8],[8,9],[9],
                                                   [10],[11],[11,12],[12],
                                                   [13],[13,14],[14],[14,15],[15],[15,16],[16],[16,17],[17],
                                                   [18],[18,19],[19],[19,20],[20],[20,21],[21],[21,22],[22],
                                                   [26],[26,27,0.75,0.25],[26,27],[26,27,0.25,0.75],[27],[26,27,-0.75,1.75],[26,27,-0.5,1.5],[26,27,-0.25,1.25],[26,27,-1,2]];

         var drawDescriptorForWarriorWithShield =
            [[25,25,0.5,0.5,10],
             [0],[0,1],[1],[1,2],[2],[2,3],[3],[3,4],[4],
             [5],[5,6],[6],[6,7],[7],[7,8],[8],[8,9],[9],
             [10],[11],[11,12],[12],
             [13],[13,14],[14],[14,15],[15],[15,16],[16],[16,17],[17],
             [18],[18,19],[19],[19,20],[20],[20,21],[21],[21,22],[22],
             [28,28,0.5,0.5,10]];

         var drawDescriptorForWarriorWithWeaponAndShield =
            [[23],[23,24,0.75,0.25],[23,24],[23,24,0.25,0.75],[24],[23,24,-0.25,1.25],[23,24,-0.5,1.5],[23,24,-0.75,1.75],[23,24,-1,2],[25,25,0.5,0.5,10],
             [0],[0,1],[1],[1,2],[2],[2,3],[3],[3,4],[4],
             [5],[5,6],[6],[6,7],[7],[7,8],[8],[8,9],[9],
             [10],[11],[11,12],[12],
             [13],[13,14],[14],[14,15],[15],[15,16],[16],[16,17],[17],
             [18],[18,19],[19],[19,20],[20],[20,21],[21],[21,22],[22],
             [26],[26,27,0.75,0.25],[26,27],[26,27,0.25,0.75],[27],[26,27,-0.75,1.75],[26,27,-0.5,1.5],[26,27,-0.25,1.25],[26,27,-1,2],[28,28,0.5,0.5,10]];

         var drawDescriptors = [drawDescriptorForWarrior,drawDescriptorForWarriorWithWeapon,drawDescriptorForWarriorWithShield, drawDescriptorForWarriorWithWeaponAndShield];

         var descriptorValueToColor=[2,2,2,2,2,
                                     3,3,3,3,3,
                                     0,1,1,
                                     4,4,4,4,4,
                                     5,5,5,5,5,
                                     6,6,7,6,6,7];

         var weaponDrawData = [
                           [[17,52,5],[1,47,5],[20,0,5],[30,0,5],[40,0,5],[27,62,5]],
                           [[1,-0,5],[10,-0,5],[20,0,5],[13,55,5],[-0,46,5],[29,61,5]],
                           [[28,55,5],[10,51,5],[20,0,5],[30,0,5],[40,0,5],[14,57,5]],
                           [[31,54,5],[15,49,5],[19,-0,5],[30,0,5],[40,0,5],[12,56,5]],
                           [[34,54,5],[18,52,5],[20,0,5],[30,0,5],[40,0,5],[13,54,5]],
                           [[28,60,5],[13,55,5],[20,0,5],[29,-0,5],[39,-0,5],[15,58,5]],
                           [[13,55,5],[1,48,5],[20,0,5],[30,0,5],[40,0,5],[27,60,5]],
                           [[13,50,5],[1,39,5],[20,0,5],[30,0,5],[40,0,5],[34,56,5]],
                           [[12,51,5],[0,39,5],[20,0,5],[30,0,5],[40,0,5],[34,59,5]],
                           [[0,0,5],[10,0,5],[20,0,5],[12,57,5],[0,54,5],[30,63,5]],
                           [[0,0,5],[10,-0,5],[20,0,5],[13,55,5],[4,42,5],[32,57,5]],
                           [[18,50,5],[4,46,5],[20,0,5],[30,0,5],[40,0,5],[23,58,5]],
                           [[31,47,5],[13,49,5],[20,0,5],[30,0,5],[40,0,5],[20,56,5]],
                           [[31,46,5],[16,49,5],[20,0,5],[30,0,5],[40,0,5],[18,58,5]],
                           [[20,51,5],[5,49,5],[20,0,5],[30,0,5],[40,0,5],[29,59,5]],
                           [[3,0,5],[10,-0,5],[20,0,5],[12,52,5],[0,44,5],[35,52,5]],
                           [[1,-0,5],[8,-0,5],[20,0,5],[10,52,5],[1,39,5],[41,54,5]],
                           [[1,-0,5],[9,0,5],[20,0,5],[9,54,5],[2,40,5],[39,56,5]],
                           [[0,0,5],[10,0,5],[20,0,5],[15,59,5],[10,52,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[19,0,5],[15,57,5],[15,45,5],[35,56,5]],
                           [[19,51,5],[11,54,5],[20,0,5],[30,0,5],[40,0,5],[31,52,5]],
                           [[18,52,5],[10,53,5],[20,0,5],[30,0,5],[40,0,5],[26,57,5]],
                           [[0,-0,5],[10,0,5],[20,0,5],[18,54,5],[10,58,5],[30,59,5]],
                           [[2,-0,5],[10,-0,5],[20,0,5],[16,56,5],[7,51,5],[33,57,5]],
                           [[0,0,5],[10,0,5],[31,51,5],[18,54,5],[19,47,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[30,50,5],[23,57,5],[26,47,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[30,54,5],[18,59,5],[22,48,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[39,56,5],[20,60,5],[37,53,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[31,50,5],[21,58,5],[36,50,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[38,51,5],[13,54,5],[31,55,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[40,51,5],[11,54,5],[26,55,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[40,52,5],[11,56,5],[25,55,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[36,55,5],[17,57,5],[31,55,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[30,51,5],[26,57,5],[39,48,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[19,47,5],[31,55,5],[41,46,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[19,46,5],[32,55,5],[43,44,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[30,53,5],[20,62,5],[37,56,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[20,58,5],[32,57,5],[42,49,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[34,52,5],[19,59,5],[37,55,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[34,49,5],[12,55,5],[30,56,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[35,52,5],[12,60,5],[29,58,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[33,55,5],[19,61,5],[35,57,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[18,55,5],[32,57,5],[45,47,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[15,52,5],[35,54,5],[42,43,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[13,53,5],[34,54,5],[43,45,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[15,56,5],[34,61,5],[45,51,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[14,53,5],[34,58,5],[39,44,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[24,45,5],[28,59,5],[39,54,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[26,50,5],[23,61,5],[37,56,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[26,51,5],[22,63,5],[35,60,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[16,54,5],[24,61,5],[34,54,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[13,53,5],[33,56,5],[40,46,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[12,54,5],[36,54,5],[43,42,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[9,55,5],[36,52,5],[43,39,5],[50,0,5]],
                           [[35,59,5],[35,46,5],[13,59,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[34,56,5],[34,50,5],[14,57,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[33,55,5],[31,43,5],[18,51,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[30,54,5],[32,43,5],[22,54,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[32,59,5],[34,49,5],[19,54,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[34,56,5],[35,46,5],[15,57,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[31,48,5],[23,41,5],[16,56,5],[30,0,5],[40,0,5],[51,-0,5]],
                           [[28,49,5],[24,43,5],[17,54,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[30,53,5],[26,47,5],[16,60,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[33,55,5],[17,45,5],[20,0,5],[30,0,5],[40,0,5],[14,60,5]],
                           [[28,55,5],[13,46,5],[20,0,5],[30,0,5],[40,0,5],[22,61,5]],
                           [[33,53,5],[19,46,5],[20,0,5],[30,0,5],[40,0,5],[15,55,5]],
                           [[35,55,5],[19,49,5],[20,0,5],[30,0,5],[40,0,5],[12,54,5]],
                           [[37,56,5],[21,51,5],[20,0,5],[30,0,5],[40,0,5],[11,51,5]],
                           [[34,52,5],[18,45,5],[20,0,5],[30,0,5],[40,0,5],[15,57,5]],
                           [[26,51,5],[13,41,5],[20,0,5],[30,0,5],[40,0,5],[21,59,5]],
                           [[27,51,5],[11,41,5],[19,-0,5],[30,0,5],[40,0,5],[25,60,5]],
                           [[26,52,5],[12,43,5],[20,0,5],[30,0,5],[40,0,5],[25,62,5]],
                           [[0,0,5],[10,0,5],[20,0,5],[30,0,5],[40,0,5],[50,0,5]],
                           [[0,0,5],[10,0,5],[20,0,5],[30,0,5],[40,0,5],[50,0,5]],
                         ];

         var heroColoring =['orange','lightgreen','orange','green','orange','green','cyan','black'];
         var devilColoring =['magenta','red','magenta','red','magenta','red','red','red'];

         //================================== AVATAR ANIMATION ENDS =================================

         var levelMap= [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,4,0,0,0,0,0,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                        [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,4,0,4,0,0,0,0,1,4,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,1,0,0,0,1,0,1,0,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,1,0,0,0,1,0,1,4,1,0,0,0,0,0,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,1,4,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                        [0,0,1,1,1,1,1,1,4,1,1,4,1,1,1,1,1,1,1,1,4,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                        [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

         var figurePhase     = 0;
         
         // all characters on the map - 0th is the player
         var characters = [[[15.5,15.5],0,0,[],{scale:1,coloring:heroColoring,weapon:1,shield:1,slowness:5,range:50}],
                           [[10.5,10.5],0,0,[],{scale:0.75,coloring:devilColoring,weapon:0,shield:0,slowness:10,range:4}],
                           [[6.5,10.5],0,0,[],{scale:0.75,coloring:devilColoring,weapon:0,shield:0,slowness:10,range:4}],
                           [[7.5,11.5],0,0,[],{scale:0.75,coloring:devilColoring,weapon:0,shield:0,slowness:10,range:4}],
                           [[7.5,12.5],0,0,[],{scale:0.75,coloring:devilColoring,weapon:0,shield:0,slowness:10,range:4}],
                          ]; /*positin, faceDir (0 is south, 1 is east, 2 is north, 3 is west), phase, path*/

         function manhattan(p1,p2) {
            return Math.abs(p1[0]-p2[0]) + Math.abs(p1[1]-p2[1]);
         }

         function drawBox(boxX,boxY,boxSize,boxColor) {
            context.beginPath();
            context.rect(boxX, boxY, boxSize, boxSize);
            context.fillStyle = boxColor;
            context.fill();
         }

         function drawBoxExtended(ux,uy,rimage,wimage,scale,characterColors,ind1,ind2,w1,w2,rad) {
            var simage = rimage;
            var cind = ind1;
            if ( w1 === undefined ) {
               w1 = 0.5;
            }
            if ( w2 === undefined ) {
               w2 = 0.5;
            }
            if ( ind1 > 22 ) {
               simage = wimage;
               ind1 -= 23;
               if ( ind2 !== undefined ) {
                  ind2 -= 23;
               }
               if ( simage[ind1][1] < 3 ) {
                  return;
               }
            }
            var percentage = tileSize / 50;
            if ( ind2 === undefined ) {
               drawBox(ux+simage[ind1][0]*percentage,
                       uy+simage[ind1][1]*percentage*scale,
                       simage[ind1][2]*percentage,
                       characterColors[descriptorValueToColor[cind]]);
            } else {
               drawBox(ux+(Math.floor(simage[ind1][0]*w1+simage[ind2][0]*w2)-(rad===undefined?0:rad))*percentage,
                       uy+(Math.floor(simage[ind1][1]*w1+simage[ind2][1]*w2)-(rad===undefined?0:rad))*percentage*scale,
                       (rad===undefined?simage[ind1][2]:rad*2)*percentage,
                       characterColors[descriptorValueToColor[cind]]);
            }
         }

         function drawCharacter(y,x,i) {
            var [phaseKey, scale, drawDescriptor, characterColors] = [getKey(characters[i][1], characters[i][2]), characters[i][4].scale,
                                                                      drawDescriptors[characters[i][4].weapon + characters[i][4].shield*2], characters[i][4].coloring];
            var cx = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var cy = (x - y) * tileSize + screenHeight / 2;
            var [rimage, wimage] = [characterBodyDrawData[phaseKey], weaponDrawData[phaseKey]];
            var ylimitratio = 1.0;
            var percentage = tileSize / 50;
            var ymax = 100 * percentage * scale;
            var xmax = 54  * percentage;
            var ux = Math.floor(cx - xmax/2);
            var uy = Math.floor(cy - ymax + ymax * percentage * 0.1);
            var mx = ux+ux+xmax;
            drawDescriptor.map(box=>drawBoxExtended(ux,uy,rimage,wimage,scale,characterColors,...box));
         }

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         function contextPathForObjectDraw(obj) {
            context.beginPath();
            for ( var i = 0; i < obj.ps.length; ++i ) {
               ( i == 0 ? context.moveTo( Math.floor(obj.ps[i].x), Math.floor(obj.ps[i].y) ) : context.lineTo( Math.floor(obj.ps[i].x), Math.floor(obj.ps[i].y) ) );
            }
            context.closePath();
         }

         function drawFloor(tile, color) {
            context.fillStyle = color;
            context.strokeStyle = color;
            contextPathForObjectDraw(tile);
            context.fill();
            context.stroke();
         }

         function drawTile(tile,color) {
            context.strokeStyle = color;
            contextPathForObjectDraw(tile);
            context.stroke();
         }

         function getFloorTile(y,x,obi) {
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            obi.ps = [{x:px,y:py-tileSize},{x:px + Math.sqrt(3) * tileSize,y:py},{x:px,y:py+tileSize},{x:px - Math.sqrt(3) * tileSize,y:py}];
            return obi;
         }

         function getKey(diri,phi) {
            return (1+diri*2)*9 + phi;
         }

         function drawCursor(x,y) {
            context.fillStyle = "red";
            contextPathForObjectDraw({ps:[{x:x,y:y},{x:x+15,y:y+20},{x:x,y:y+25}]});
            context.fill();
         }

         function drawWall(y,x,num, color) {
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;

            var bit1 = (num % 2) * 2 - 1;
            var bit2 = (num >= 2) * 2 - 1;

            if ( num < 2 ) {
               context.globalAlpha = 1.0;
               context.fillStyle   = color;
            } else {
               context.globalAlpha = 0.75;
               context.fillStyle   = "#000000";
            }
            var sy = 1;
            contextPathForObjectDraw( {ps:[{x:px,y:py + bit2 * tileSize+sy},{x:px + bit1 * Math.sqrt(3) * tileSize, y:py+sy},{x:px + bit1 * Math.sqrt(3) * tileSize, y:py - 2 * tileSize+sy},{x:px, y:py + bit2 * tileSize - 2 * tileSize+sy}]} );
            context.fill();
            context.globalAlpha = 1.0;
         }

         function getMapCell(y,x) {
            return ( y < levelMap.length && y >= 0 && x < levelMap[y].length && x >= 0 ? levelMap[y][x] : 0 );
         }

         function isMapCellVisible(y,x,cy,cx,oy,ox,sx=0.5+ox,sy=0.5+oy) {
            var dirY  = y - oy;
            var dirX  = x - ox;
            var dirL  = Math.hypot(dirX,dirY);
            dirY /= dirL;
            dirX /= dirL;

            var celly   = cy;
            var cellx   = cx;

            var dist    = 0;
            var arrived = 0;
            var limit   = 50;
            var err     = 1e-6;

            while ( limit && getMapCell( celly, cellx ) != 0 && !( celly == cy + y && cellx == cx + x ) ) {
               --limit;
               var jump  = Math.min( Math.max( ( 1 - sx ) / dirX, -sx / dirX ),
                                     Math.max( ( 1 - sy ) / dirY, -sy / dirY ) );
               dist += jump;
               sx = sx + dirX * jump;
               sy = sy + dirY * jump;
               if ( Math.abs(sx) < err && dirX < 0) {
                  sx = 1;
                  cellx -= 1;
                  arrived = 1;
               } else if ( Math.abs(1-sx) < err && dirX > 0 ) {
                  sx = 0;
                  cellx += 1;
                  arrived = 2;
               }
               if ( Math.abs(sy) < err && dirY < 0 ) {
                  sy = 1;
                  celly -= 1;
                  arrived = 3;
               } else if ( Math.abs(1-sy) < err && dirY > 0 ) {
                  sy = 0;
                  celly += 1;
                  arrived = 4;
               }
            }

            return ( celly == cy + y && cellx == cx + x );
         }

         function drawCellFloor(y,x,cy,cx,oy,ox,tiles) {
            if ( getMapCell(cy+y,cx+x) != 5 ) {
               var tile = getFloorTile(-y+oy,x-ox,{x:x+cx,y:y+cy});
               drawFloor(tile, "#AAAAAA");
               tiles.push(tile);
            }
         }

         function drawCell(y,x,cy,cx,oy,ox,characterIndexer) {
            if ( !getMapCell(cy+y,cx+x-1) ) {
               drawWall(-y+oy,x-ox,0, "gray");
            }
            if ( !getMapCell(cy+y-1,cx+x) ) {
               drawWall(-y+oy,x-ox,1, "gray");
            }

            var i = characterIndexer[getIndexKey([cy+y,cx+x])];
            if ( i !== undefined ) {
               drawCharacter((oy+cy+0.5)-(characters[i][0][0]),-(ox+cx+0.5)+(characters[i][0][1]),i);
            }

            if ( !getMapCell(cy+y+1,cx+x) ) {
               drawWall(-y+oy,x-ox,2, "blue");
            }
            if ( !getMapCell(cy+y,cx+x+1) ) {
               drawWall(-y+oy,x-ox,3, "blue");
            }
         }

         function getIndexKey(ps) {
            return Math.floor(ps[0])*4*mapRadius+Math.floor(ps[1]);
         }

         function createCharacterIndex() {
            var characterIndex = {};
            for ( var i = 0; i < characters.length; ++i ) {
               characterIndex[ getIndexKey(characters[i][0]) ] = i;
            }
            return characterIndex;
         }

         function drawForeground( camCenter, characterIndex, visibleTiles ) {
            var cy = Math.floor(camCenter[0]);
            var cx = Math.floor(camCenter[1]);
            var oy = camCenter[0] - cy - 0.5;
            var ox = camCenter[1] - cx - 0.5;

            var cellsy = [];
            var cellsx = [];

            for ( var y = -mapRadius; y < mapRadius; ++y ) {
               for ( var x = -mapRadius; x < mapRadius; ++x ) {
                  if ( isMapCellVisible(y,x,cy,cx,oy,ox) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,0,0) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,0,1) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,1,0) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,1,1) )
                  {
                     if ( getMapCell(cy+y,cx+x) ) {
                        cellsy.push(y);
                        cellsx.push(x);
                     }
                  }
               }
            }

            for ( var i = 0; i < cellsx.length; ++i ) {
               drawCellFloor(cellsy[i],cellsx[i],cy,cx,oy,ox,visibleTiles);
            }

            for ( var i = 0; i < cellsx.length; ++i ) {
               drawCell(cellsy[i],cellsx[i],cy,cx,oy,ox,characterIndex);
            }
         }

         function getPointSide(p1,p2,p3) {
            return Math.sign( (p1.y-p2.y) * (p3.x-p1.x) + (p2.x-p1.x) * (p3.y-p1.y) );
         }

         function isPointInTriangle(p1,p2,p3,pt) {
            var retval = ( getPointSide(p1,p2,p3) * getPointSide(p1,p2,pt) >= 0 )
                      && ( getPointSide(p2,p3,p1) * getPointSide(p2,p3,pt) >= 0 )
                      && ( getPointSide(p3,p1,p2) * getPointSide(p3,p1,pt) >= 0 );
            return retval;
         }

         function bfs(source,target,characterIndex = createCharacterIndex()) {
            if ( !getMapCell(source.y,source.x) ) {
               return [];
            }
            var hops = {};
            var findings = [[source.y,source.x]];
            hops[findings[0]]=false;
            var level = 0;
            var dirs = [[0,1],[-1,0],[0,-1],[1,0]];
            while ( level < 10 && findings.length > 0 ) {
               ++level;
               var nfindings = [];
               for ( var i = 0; i < findings.length; ++i ) {
                  for ( var mag = 0; mag <= 1*(getMapCell(findings[i][0],findings[i][1]) == 6); ++mag ) {
                     for ( var j = 0; j < dirs.length; ++j ) {
                        var nextp = [(findings[i][0]+dirs[j][1]),(findings[i][1]+dirs[j][0])];
                        if ( getMapCell(nextp[0],nextp[1])
                          && hops[nextp] === undefined
                          && (nextp[0] === target.y && nextp[1] === target.x || characterIndex[getIndexKey([nextp[0],nextp[1]])] === undefined ) ) { // enemies shadowing the areas behind of them, but not themselves
                           nfindings.push(nextp);
                           hops[nextp] = findings[i];
                        }
                     }
                  }
               }
               findings = nfindings;
            }
            var tara = [target.y,target.x];
            var way = [];
            if ( hops[tara] !== undefined ) {
               way.push(tara);
               var maxi = 100;
               while(hops[tara] && maxi-- ) {
                  way.push(hops[tara]);
                  tara = hops[tara];
               }
            }
            way.reverse();
            return way;
         }

         function getCursorsTile(tiles, cx, cy) {
            for ( var i = 0; i < tiles.length; ++i ) {
               if ( isPointInTriangle( tiles[i].ps[0], tiles[i].ps[1], tiles[i].ps[3], {x:cx,y:cy} )
                 || isPointInTriangle( tiles[i].ps[1], tiles[i].ps[2], tiles[i].ps[3], {x:cx,y:cy} ) ) {
                  return tiles[i];
               }
            }
         }

         function moveCharacter(index, characterIndex) {
            if ( characters[index][3].length == 0 ) {
               characters[index][2] = 0;
               return; 
            }

            characters[index][2] = ( (characters[index][2]) % 8 + 1 );

            var ctar = characters[index][3][0];
           
            for ( var i = 0; i < 2; ++i ) {
               var targetDistance = Math.abs(ctar[i] + 0.5 - characters[index][0][i]);
               if ( targetDistance > errorTolerance ) {
                  var sgn = Math.sign( ctar[i] + 0.5 - characters[index][0][i] );
                  var incred = [characters[index][0][0],characters[index][0][1]];
                  incred[i] += (0.5/characters[index][4].slowness) * sgn;
                  if ( characterIndex[getIndexKey(incred)] !== undefined && characterIndex[getIndexKey(incred)] !== index ) { // attack
                     characters[index][3] = [[Math.floor(characters[index][0][0]),Math.floor(characters[index][0][1])]];
                     return;
                  }
                  characters[index][0] = incred;
                  if ( characters[index][3].length > 1 || targetDistance > 0.5 ) { // not adjusting direction after attack
                     characters[index][1] = 2 * ( sgn < 0 ) + i;
                  }
                  return;
               } else {
                  characters[index][0][i] = ctar[i] + 0.5;
               }
            }

            characters[index][3].reverse();
            characters[index][3].pop();
            characters[index][3].reverse();
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               var characterIndex = createCharacterIndex();
               drawBackground();
               var visibleTiles = [];
               drawForeground(characters[0][0], characterIndex, visibleTiles);
               drawCursor(curX,curY);
               currentTarget = getCursorsTile(visibleTiles,curX,curY);
               if ( currentTarget !== undefined ) {
                  var characterIndexOnSelectedCell = characterIndex[getIndexKey([currentTarget.y,currentTarget.x])];
                  drawTile(currentTarget, characterIndexOnSelectedCell === undefined ? "yellow" : (characterIndexOnSelectedCell === 0 ? "blue" : "red"));
               }
               ANIMATION = requestAnimationFrame(drawScene);
               for ( var i = 0; i < characters.length; ++i ) {
                  moveCharacter(i, createCharacterIndex()); // easy full update for now
               }
               if ( aiCounter < aiFrequencyDecreaseRatio ) {
                  ++aiCounter;
               } else {
                  aiCounter = 0;
                  for ( var i = 1; i < characters.length; ++i ) {
                     if ( manhattan(characters[0][0], characters[i][0]) <= characters[i][4].range
                       && characters[i][3].length == 0 ) {
                        characters[i][3] = bfs({x:Math.floor(characters[i][0][1]),y:Math.floor(characters[i][0][0])},
                                               {x:Math.floor(characters[0][0][1]),y:Math.floor(characters[0][0][0])},
                                               characterIndex);
                        console.log(i,'--->', characters[i][3], ' ',characters[i][3].length);
                     }
                  }
               }
            }, 1000 / fps );
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;
            mapRadiusX = screenWidth/4/tileSize/Math.sqrt(3);
            mapRadiusY = screenHeight/4/tileSize;
            mapRadius = Math.ceil(2 * Math.max(mapRadiusX,mapRadiusY));

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         mainItem.onmousedown = function(event) {
            if ( currentTarget === undefined ) {
               return;
            }
            var source = {x:Math.floor(characters[0][0][1]),y:Math.floor(characters[0][0][0])};
            if ( source.x === currentTarget.x && source.y === currentTarget.y ) {
               return;
            }
            characters[0][3] = bfs(source,currentTarget);
         };

         mainItem.onmouseup = function(event) {};

         mainItem.onmousemove = function(event) { [curX,curY] = [event.clientX,event.clientY]; };

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
         })();
      </script>
   </body>
</html>
